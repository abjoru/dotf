#!/bin/sh
#
# dotf

set -e 

MODE="install"
VERBOSE=false

SCALA_VERSION=2.13

AMM_VERSION=2.1.4
AMM_RELEASE_VERSION="${SCALA_VERSION}-${AMM_VERSION}-2-ef9b0a0"
AMM_URL="https://github.com/lihaoyi/Ammonite/releases/download/${AMM_VERSION}/${AMM_RELEASE_VERSION}"

SC_DIR=${XDG_DATA_HOME:-~/.local/share}/dotf

displayUsageAndExit() {
  echo "dotf -- dotfiles management"
  echo
  echo "Usage: dotf [options] <cmd>"
  echo
  echo "Options:"
  echo "  -d  Dry run a command"
  echo "  -v  Verbose output for a command"
  echo "  -h  Display this help"
  echo
  echo "Commands:"
  echo "  list [<action>]  list managed files"
  echo "  update           update managed files"
  echo "  upgrade          upgrade managed packages"
  echo "  status           show git status"
  echo
  echo "Actions:"
  echo "  pkgs   list all packages"
  exit
}

initAmmonite() {
  # Check for curl
  if [ ! -x "$(which curl)" ]; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
      brew install curl
    elif [[ "$OSTYPE" == "linux-gnu"* && -x "$(which apt)" ]]; then
      sudo apt install curl
    elif [[ "$OSTYPE" == "linux-gnu"* && -x "$(which pacman)" ]]; then
      sudo pacman -S curl
    else
      echo "Unsupported OS or package system!"
      echo "Currently supported:"
      echo "  - homebrew (osx)"
      echo "  - apt (linux)"
      echo "  - pacman (linux)"
      exit 1
    fi
  fi

  # Check for Ammonite
  if [ ! -x "$(which amm)" ]; then
    curl -L "${AMM_URL}" > $HOME/.local/bin/amm && chmod +x $HOME/.local/bin/amm
  fi
}

invalidCommand() {
  echo "Invalid Command!"
  displayUsageAndExit
}

runList() {
  amm ${SC_DIR}/cmd_list.sc "$1"
  exit
}

runUpdate() {
  pushd $HOME
  if [ "$1" == "dry" ]; then
    $(which git) --git-dir=$HOME/.dotf/ --work-tree=$HOME fetch 
    $(which git) --git-dir=$HOME/.dotf/ --work-tree=$HOME diff HEAD..@{u}
  else
    $(which git) --git-dir=$HOME/.dotf/ --work-tree=$HOME pull
  fi
  popd
  exit
}

runUpgrade() {
  amm ${SC_DIR}/cmd_upgrade.sc "$1" "$2"
  exit
}

runStatus() {
  $(which git) --git-dir=$HOME/.dotf/ --work-tree=$HOME status --short
  exit
}

# Initialize up front
initAmmonite

while getopts ':dvh' opts; do
  case $opts in
    d) MODE="dry" ;;
    v) VERBOSE=true ;;
    h) displayUsageAndExit ;;
  esac
done

shift $((OPTIND-1))

case $1 in
  list) runList "$2" ;;
  update) runUpdate "$MODE" "$VERBOSE" ;;
  upgrade) runUpgrade "$MODE" "$VERBOSE" ;;
  status) runStatus ;;
  *) invalidCommand ;;
esac
